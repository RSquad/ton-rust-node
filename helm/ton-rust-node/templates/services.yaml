{{- $root := . -}}
{{- $fullname := include "ton-rust-node.fullname" . -}}
{{- range $i, $_ := until (int .Values.replicas) }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $fullname }}-{{ $i }}
  labels:
    {{- include "ton-rust-node.labels" $root | nindent 4 }}
  {{- $prometheus := dict }}
  {{- if and $root.Values.metrics.annotations.enabled $root.Values.ports.metrics }}
  {{-   $_ := set $prometheus "prometheus.io/scrape" "true" }}
  {{-   $_ := set $prometheus "prometheus.io/port" ($root.Values.ports.metrics | toString) }}
  {{-   $_ := set $prometheus "prometheus.io/path" "/metrics" }}
  {{- end }}
  {{- $shared := $root.Values.services.annotations | default dict }}
  {{- $perReplica := dict }}
  {{- if and $root.Values.services.perReplica (lt $i (len $root.Values.services.perReplica)) }}
  {{-   $perReplica = (index $root.Values.services.perReplica $i).annotations | default dict }}
  {{- end }}
  {{- $merged := mustMergeOverwrite (deepCopy $prometheus) (deepCopy $shared) $perReplica }}
  {{- if $merged }}
  annotations:
    {{- $merged | toYaml | nindent 4 }}
  {{- end }}
spec:
  type: {{ $root.Values.services.type }}
  {{- if ne $root.Values.services.type "ClusterIP" }}
  externalTrafficPolicy: {{ $root.Values.services.externalTrafficPolicy }}
  {{- end }}
  selector:
    {{- include "ton-rust-node.selectorLabels" $root | nindent 4 }}
    statefulset.kubernetes.io/pod-name: {{ $fullname }}-{{ $i }}
  ports:
    - name: adnl
      port: {{ $root.Values.ports.adnl }}
      protocol: UDP
    {{- if $root.Values.ports.control }}
    - name: control
      port: {{ $root.Values.ports.control }}
      protocol: TCP
    {{- end }}
    {{- if $root.Values.ports.liteserver }}
    - name: liteserver
      port: {{ $root.Values.ports.liteserver }}
      protocol: TCP
    {{- end }}
    {{- if $root.Values.ports.jsonRpc }}
    - name: json-rpc
      port: {{ $root.Values.ports.jsonRpc }}
      protocol: TCP
    {{- end }}
    {{- if and $root.Values.ports.metrics $root.Values.debug.exposeMetrics }}
    - name: metrics
      port: {{ $root.Values.ports.metrics }}
      protocol: TCP
    {{- end }}
{{- end }}
